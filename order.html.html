<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é˜¿å¬¤çš„ä¾¿ç•¶ - ç·šä¸Šé»é¤</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --red:#c0392b; --red-dark:#922b21; --red-light:#fdf2f2;
    --gold:#e67e22; --green:#27ae60; --blue:#2980b9;
    --gray:#f5f5f5; --text:#2c2c2c; --sub:#888;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Noto Sans TC',sans-serif;background:#faf7f2;min-height:100vh;}
  .app{max-width:480px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;box-shadow:0 0 40px rgba(0,0,0,0.12);background:#faf7f2;}
  .header{background:linear-gradient(135deg,var(--red),var(--red-dark));padding:10px 16px 12px;color:#fff;position:sticky;top:0;z-index:100;}
  .header-title-row{text-align:center;margin-bottom:10px;}
  .store-name{font-size:22px;font-weight:900;letter-spacing:1px;}
  .store-sub{font-size:10px;opacity:.7;letter-spacing:2px;margin-bottom:3px;}
  .header-top{display:flex;justify-content:center;align-items:center;gap:8px;}
  .header-btns{display:flex;gap:8px;}
  .header-btn{background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;}
  .header-btn.active{background:#fff;color:var(--red);}
  .cart-btn{position:relative;}
  .cart-badge{position:absolute;top:-6px;right:-6px;background:var(--gold);border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;}

  .tabs{display:flex;overflow-x:auto;padding:12px 16px 0;gap:8px;background:#fff;border-bottom:1px solid #eee;scrollbar-width:none;}
  .tabs::-webkit-scrollbar{display:none;}
  .tab{white-space:nowrap;background:var(--gray);color:#555;border:none;border-radius:20px;padding:7px 16px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;}
  .tab.active{background:var(--red);color:#fff;}
  .menu-list{padding:12px 16px;display:flex;flex-direction:column;gap:10px;}
  .menu-item{background:#fff;border-radius:14px;padding:0;display:flex;align-items:stretch;box-shadow:0 2px 8px rgba(0,0,0,0.06);overflow:hidden;}
  .menu-item.soldout{opacity:.5;}
  .menu-item-img{width:100px;min-width:100px;height:100px;object-fit:cover;display:block;}
  .menu-item-img-placeholder{width:100px;min-width:100px;height:100px;background:var(--gray);display:none;}
  .menu-item-body{flex:1;padding:12px 14px;display:flex;flex-direction:column;justify-content:space-between;min-width:0;}
  .item-info{flex:1;}
  .item-name-row{display:flex;align-items:center;gap:8px;margin-bottom:3px;}
  .item-name{font-weight:700;font-size:15px;color:var(--text);}
  .tag{border-radius:4px;padding:1px 7px;font-size:10px;font-weight:700;color:#fff;}
  .tag-hot{background:#e74c3c;}.tag-rec{background:var(--gold);}
  .item-desc{font-size:12px;color:var(--sub);margin-bottom:4px;}
  .item-price{font-weight:900;color:var(--red);font-size:16px;}
  .item-controls{display:flex;align-items:center;gap:10px;}
  .ctrl-btn{width:30px;height:30px;border-radius:50%;font-size:18px;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:inherit;}
  .minus-btn{border:2px solid var(--red);background:#fff;color:var(--red);}
  .plus-btn{border:none;background:var(--red);color:#fff;box-shadow:0 3px 8px rgba(192,57,43,0.35);}
  .item-qty{font-weight:900;font-size:16px;min-width:20px;text-align:center;}
  .bottom-bar{padding:12px 16px;background:#fff;border-top:1px solid #f0f0f0;}
  .view-cart-btn{width:100%;background:linear-gradient(135deg,var(--red),var(--red-dark));color:#fff;border:none;border-radius:14px;padding:15px 24px;font-size:15px;font-weight:900;cursor:pointer;display:flex;justify-content:space-between;align-items:center;box-shadow:0 6px 20px rgba(192,57,43,0.35);font-family:inherit;}
  .cart-count-pill{background:rgba(255,255,255,0.25);border-radius:8px;padding:2px 10px;font-size:14px;}
  .page{padding:16px;flex:1;}
  .back-btn{background:none;border:none;color:var(--red);font-weight:700;font-size:14px;cursor:pointer;margin-bottom:12px;padding:0;font-family:inherit;}
  .page-title{font-weight:900;font-size:18px;margin-bottom:14px;color:var(--text);}
  .cart-items{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;}
  .cart-item{background:#fff;border-radius:12px;padding:12px 16px;display:flex;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
  .cart-item-info{flex:1;}
  .cart-item-name{font-weight:700;font-size:14px;color:var(--text);}
  .cart-item-price{color:var(--red);font-weight:700;margin-top:3px;}
  .form-box{background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px;}
  .form-title{font-weight:700;font-size:14px;margin-bottom:12px;color:var(--text);}
  .form-group{margin-bottom:10px;}
  .form-label{font-size:12px;color:var(--sub);margin-bottom:4px;display:block;}
  .form-input,.form-select,.form-textarea{width:100%;border:1.5px solid #eee;border-radius:8px;padding:9px 12px;font-size:14px;font-family:inherit;outline:none;transition:border-color .2s;}
  .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--red);}
  .form-textarea{resize:none;height:70px;}
  .total-box{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;}
  .total-amount{font-weight:900;font-size:20px;color:var(--red);}
  .submit-btn{width:100%;background:linear-gradient(135deg,var(--red),var(--red-dark));color:#fff;border:none;border-radius:14px;padding:16px;font-size:16px;font-weight:900;cursor:pointer;box-shadow:0 6px 20px rgba(192,57,43,0.4);letter-spacing:1px;font-family:inherit;}
  .empty-cart{text-align:center;padding:60px 0;color:var(--sub);}
  .done-page{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 24px;text-align:center;flex:1;}
  .done-icon{font-size:72px;margin-bottom:16px;}
  .done-title{font-weight:900;font-size:24px;color:var(--green);margin-bottom:8px;}
  .done-badge{background:#f0faf5;border-radius:12px;padding:12px 24px;margin-bottom:24px;color:var(--green);font-weight:700;}
  .again-btn{background:var(--red);color:#fff;border:none;border-radius:12px;padding:14px 40px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;}

  /* Admin */
  .admin-tabs{display:flex;gap:0;background:#fff;border-bottom:2px solid #eee;margin-bottom:16px;}
  .admin-tab{flex:1;background:none;border:none;padding:12px 0;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;color:var(--sub);border-bottom:3px solid transparent;margin-bottom:-2px;}
  .admin-tab.active{color:var(--red);border-bottom-color:var(--red);}
  .admin-stats{display:flex;gap:10px;margin-bottom:16px;}
  .stat-card{flex:1;background:#fff;border-radius:12px;padding:12px 0;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
  .stat-num{font-weight:900;font-size:24px;}
  .stat-label{font-size:11px;color:var(--sub);margin-top:2px;}
  .order-cards{display:flex;flex-direction:column;gap:12px;}
  .order-card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.07);}
  .order-card-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
  .order-id{font-weight:900;color:var(--red);font-size:14px;}
  .order-type-badge{border-radius:6px;padding:2px 8px;font-size:11px;font-weight:700;}
  .badge-delivery{background:#eaf4ff;color:var(--blue);}
  .badge-pickup{background:#fff8e6;color:var(--gold);}
  .status-badge{border-radius:8px;padding:4px 12px;font-size:12px;font-weight:700;}
  .order-customer{font-weight:700;font-size:15px;color:var(--text);margin-bottom:4px;}
  .order-items-text{font-size:13px;color:#666;margin-bottom:8px;}
  .order-card-bottom{display:flex;justify-content:space-between;align-items:center;}
  .order-time{font-size:13px;color:var(--sub);}
  .order-right{display:flex;align-items:center;gap:10px;}
  .order-total{font-weight:900;color:var(--red);}
  .next-btn{border:none;border-radius:8px;padding:6px 14px;font-size:12px;font-weight:700;cursor:pointer;color:#fff;font-family:inherit;}
  .no-orders{text-align:center;padding:60px 0;color:var(--sub);font-size:15px;}

  /* Menu Manager */
  .menu-mgr-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .add-item-btn{background:var(--red);color:#fff;border:none;border-radius:10px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;}
  .mgr-tabs{display:flex;overflow-x:auto;gap:8px;margin-bottom:14px;scrollbar-width:none;}
  .mgr-tabs::-webkit-scrollbar{display:none;}
  .mgr-tab{white-space:nowrap;background:var(--gray);color:#555;border:none;border-radius:20px;padding:6px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;}
  .mgr-tab.active{background:var(--red);color:#fff;}
  .mgr-item{background:#fff;border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:8px;}
  .mgr-item-info{flex:1;}
  .mgr-item-name{font-weight:700;font-size:14px;color:var(--text);}
  .mgr-item-sub{font-size:12px;color:var(--sub);margin-top:2px;}
  .mgr-item-actions{display:flex;gap:6px;align-items:center;}
  .toggle-btn{border:none;border-radius:6px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;}
  .toggle-on{background:#e8f8f0;color:var(--green);}
  .toggle-off{background:#fdf2f2;color:var(--red);}
  .delete-btn{background:#fdf2f2;color:var(--red);border:none;border-radius:6px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;}

  /* Modal */
  .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:200;display:flex;align-items:flex-end;justify-content:center;}
  .modal{background:#fff;border-radius:20px 20px 0 0;padding:24px 20px;width:100%;max-width:480px;max-height:85vh;overflow-y:auto;}
  .modal-title{font-weight:900;font-size:18px;margin-bottom:16px;color:var(--text);}
  .modal-btns{display:flex;gap:10px;margin-top:16px;}
  .modal-cancel{flex:1;background:var(--gray);color:var(--text);border:none;border-radius:10px;padding:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;}
  .modal-save{flex:2;background:var(--red);color:#fff;border:none;border-radius:10px;padding:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;}

  .notif{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;padding:10px 24px;border-radius:30px;font-weight:700;font-size:14px;z-index:999;box-shadow:0 4px 16px rgba(0,0,0,0.2);opacity:0;transition:opacity .3s;pointer-events:none;}
  .notif.show{opacity:1;}

  /* Person selector */
  .person-bar{background:#fff;border-bottom:1px solid #eee;padding:12px 16px;display:flex;flex-direction:column;gap:8px;}
  .person-type-row{display:flex;gap:8px;}
  .person-type-btn{flex:1;border:2px solid #eee;background:#fff;color:#888;border-radius:10px;padding:8px 0;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;}
  .person-type-btn.active{border-color:var(--red);background:var(--red-light);color:var(--red);}
  .person-name-row{display:flex;gap:8px;align-items:center;}
  .person-name-input{flex:1;border:1.5px solid #eee;border-radius:8px;padding:8px 12px;font-size:14px;font-family:inherit;outline:none;transition:border-color .2s;}
  .person-name-input:focus{border-color:var(--red);}

  /* Bottom bar multi-button */
  .bottom-btns{display:flex;gap:8px;}
  .next-person-btn{flex:1;background:#fff;color:var(--red);border:2px solid var(--red);border-radius:12px;padding:13px 0;font-size:14px;font-weight:900;cursor:pointer;font-family:inherit;}
  .view-cart-btn-sm{flex:1;background:linear-gradient(135deg,var(--red),var(--red-dark));color:#fff;border:none;border-radius:12px;padding:13px 0;font-size:14px;font-weight:900;cursor:pointer;font-family:inherit;box-shadow:0 4px 12px rgba(192,57,43,0.35);}

  /* Cart - per-person groups */
  .person-group{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.07);margin-bottom:12px;}
  .person-group-header{background:var(--red-light);padding:10px 16px;display:flex;justify-content:space-between;align-items:center;}
  .person-group-name{font-weight:900;color:var(--red);font-size:14px;}
  .person-group-subtotal{font-weight:700;color:var(--red);font-size:14px;}
  .person-group-body{padding:8px 0;}
  .person-item-row{display:flex;justify-content:space-between;align-items:center;padding:6px 16px;}
  .person-item-name{font-size:13px;color:var(--text);}
  .person-item-price{font-size:13px;color:var(--sub);font-weight:700;}
  .remove-person-btn{background:none;border:none;color:#ccc;font-size:16px;cursor:pointer;padding:0 4px;}
  .grand-total-box{background:#fff;border-radius:12px;padding:14px 16px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:8px;}
  .grand-total-row{display:flex;justify-content:space-between;font-size:13px;color:#666;margin-bottom:4px;}
  .grand-total-final{display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:8px;border-top:1px dashed #eee;}
  /* Order lookup */
  .lookup-page{padding:16px;flex:1;}
  .lookup-box{background:#fff;border-radius:14px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.07);margin-bottom:16px;}
  .lookup-title{font-weight:900;font-size:16px;color:var(--text);margin-bottom:14px;}
  .lookup-result{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.07);margin-bottom:12px;}
  .lookup-result-header{background:var(--red-light);padding:10px 16px;display:flex;justify-content:space-between;align-items:center;}
  .lookup-result-id{font-weight:900;color:var(--red);font-size:13px;}
  .lookup-result-status{font-size:11px;font-weight:700;border-radius:6px;padding:2px 10px;}
  .lookup-result-body{padding:10px 16px;}
  .lookup-result-row{display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;}
  .lookup-edit-btn{width:100%;background:var(--blue);color:#fff;border:none;border-radius:10px;padding:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:8px;}
  /* Menu slots */
  .slot-card{background:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 2px 6px rgba(0,0,0,0.07);margin-bottom:8px;border:2px solid transparent;}
  .slot-card.active-slot{border-color:var(--green);background:#f0faf5;}
  .slot-card-top{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
  .slot-name{font-weight:700;font-size:14px;flex:1;color:var(--text);}
  .slot-active-badge{background:var(--green);color:#fff;border-radius:6px;padding:2px 8px;font-size:11px;font-weight:700;}
  .slot-url{font-size:10px;color:var(--sub);margin-bottom:8px;word-break:break-all;background:#f8f8f8;border-radius:6px;padding:4px 8px;}
  .slot-btns{display:flex;gap:6px;}
  .slot-use-btn{flex:1;background:var(--red);color:#fff;border:none;border-radius:8px;padding:7px 0;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;}
  .slot-use-btn.is-active{background:var(--green);}
  .slot-edit-btn{background:#eaf4ff;color:var(--blue);border:none;border-radius:8px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;}
  .slot-del-btn{background:#fdf2f2;color:var(--red);border:none;border-radius:8px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;}
  .hidden{display:none!important;}
</style>
</head>
<body>
<div class="app">
  <div class="notif" id="notif"></div>

  <!-- HEADER -->
  <div class="header" id="header">
    <div class="header-title-row">
      <div class="store-sub">LINE é»é¤ç³»çµ±</div>
      <div class="store-name" id="storeName">ğŸ± é˜¿å¬¤çš„ä¾¿ç•¶</div>
    </div>
    <div class="header-top">
      <div class="header-btns">
        <button class="header-btn" onclick="openShopInfo()">ğŸª åº—å®¶è³‡è¨Š</button>
        <button class="header-btn" onclick="goLookup()">ğŸ“‹ æˆ‘çš„è¨‚å–®</button>
        <button class="header-btn" id="adminBtn" onclick="toggleAdmin()">âš™ï¸ åº—å®¶ç®¡ç†</button>
      </div>
      <!-- cartBadge ä¿ç•™ä¾› JS ä½¿ç”¨ï¼Œè¦–è¦ºä¸Šä¸é¡¯ç¤º -->
      <span id="cartBadge" style="display:none;">0</span>
    </div>
  </div>

  <!-- SHOP STATUS BANNER -->
  <div id="shopClosedBanner" class="hidden" style="background:#c0392b;color:#fff;text-align:center;padding:14px 16px;font-size:14px;font-weight:700;letter-spacing:1px;">
    ğŸ”´ ç›®å‰ä¼‘æ¯ä¸­ï¼Œæš«åœæ¥å—è¨‚å–®
  </div>

  <!-- SHOP INFO MODAL -->
  <div id="shopInfoModal" style="display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:20px;">
    <div style="background:#fff;border-radius:20px;width:100%;max-width:400px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,0.2);">
      <!-- Modal header -->
      <div style="background:linear-gradient(135deg,var(--red),var(--red-dark));padding:18px 20px;display:flex;justify-content:space-between;align-items:center;">
        <div style="color:#fff;font-weight:900;font-size:16px;">ğŸª åº—å®¶è³‡è¨Š</div>
        <button onclick="closeShopInfo()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;font-size:16px;cursor:pointer;font-family:inherit;line-height:1;">âœ•</button>
      </div>
      <!-- Modal body -->
      <div style="padding:20px;display:flex;flex-direction:column;gap:14px;" id="shopInfoBody">
      </div>
    </div>
  </div>

  <!-- ANNOUNCEMENT POPUP -->
  <div id="announcementPopup" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;padding:24px;">
    <div style="background:#fff;border-radius:20px;width:100%;max-width:380px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,0.25);">
      <div style="background:linear-gradient(135deg,var(--red),var(--red-dark));padding:16px 20px;text-align:center;">
        <div style="font-size:28px;margin-bottom:4px;">ğŸ“¢</div>
        <div style="color:#fff;font-weight:900;font-size:15px;">åº—å®¶å…¬å‘Š</div>
      </div>
      <div style="padding:22px 20px;">
        <div id="announcementText" style="font-size:15px;color:#333;line-height:1.8;text-align:center;font-weight:500;"></div>
      </div>
      <div style="padding:0 20px 20px;">
        <button onclick="closeAnnouncement()" style="width:100%;background:var(--red);color:#fff;border:none;border-radius:12px;padding:13px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <!-- MENU VIEW -->
  <div id="menuView">
    <!-- Person selector bar -->
    <div class="person-bar">
      <div class="person-type-row">
        <button class="person-type-btn active" id="btnSelf" onclick="setPersonType('self')">ğŸ™‹ è‡ªå·±çš„</button>
        <button class="person-type-btn" id="btnOther" onclick="setPersonType('other')">ğŸ‘« åˆ¥äººçš„</button>
      </div>
      <div class="person-name-row">
        <input class="person-name-input" id="currentPersonName" placeholder="è«‹è¼¸å…¥å§“å" oninput="updateCurrentName()">
        <span id="personCount" style="font-size:12px;color:var(--sub);white-space:nowrap;"></span>
      </div>
    </div>
    <div id="menuLoading" class="hidden" style="text-align:center;padding:40px 0;color:var(--sub);">
      <div style="font-size:32px;margin-bottom:8px;">ğŸ”„</div>
      <div style="font-size:13px;">æ­£åœ¨å¾è©¦ç®—è¡¨è¼‰å…¥æœ€æ–°èœå–®...</div>
    </div>
    <div class="tabs" id="tabs"></div>
    <div class="menu-list" id="menuList"></div>
    <div class="bottom-bar hidden" id="bottomBar">
      <div class="bottom-btns">
        <button class="next-person-btn" onclick="nextPerson()">ï¼‹ ä¸‹ä¸€ä½</button>
        <button class="view-cart-btn-sm" onclick="goCart()">æŸ¥çœ‹è³¼ç‰©è»Š ğŸ›’ <span id="bottomTotal" style="font-size:12px;opacity:.85;"></span></button>
      </div>
    </div>
  </div>

  <!-- CART VIEW -->
  <div id="cartView" class="hidden">
    <div class="page">
      <button class="back-btn" onclick="goMenu()">â† ç¹¼çºŒé»é¤</button>
      <div class="page-title">ğŸ›’ è³¼ç‰©è»Š</div>
      <div id="cartEmpty" class="empty-cart">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ±</div>
        <div>é‚„æ²’æœ‰ä»»ä½•äººé»é¤</div>
        <div style="font-size:12px;margin-top:8px;">é¸å®Œé¤æŒ‰ã€Œï¼‹ ä¸‹ä¸€ä½ã€åŠ å…¥è³¼ç‰©è»Š</div>
      </div>
      <div id="cartContent" class="hidden">
        <div id="personGroups"></div>
        <div class="grand-total-box">
          <div id="grandTotalRows"></div>
          <div class="grand-total-final">
            <span style="font-weight:900;font-size:15px;">ç¸½è¨ˆ</span>
            <span class="total-amount">NT$ <span id="grandTotal">0</span></span>
          </div>
        </div>
        <div class="form-box">
          <div class="form-title">ğŸ“‹ å–é¤è³‡æ–™</div>
          <div class="form-group">
            <label class="form-label">å–é¤æ™‚é–“</label>
            <select class="form-select" id="inputTime">
              <option>ç›¡å¿«å–é¤</option>
              <option>11:00</option><option>11:30</option><option>12:00</option><option>12:30</option>
              <option>13:00</option><option>17:30</option><option>18:00</option><option>18:30</option><option>19:00</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label><textarea class="form-textarea" id="inputNote" placeholder="ä¾‹ï¼šä¸è¦è¾£ã€é£¯å°‘ä¸€é»..."></textarea></div>
        </div>
        <button class="submit-btn" id="submitBtn" onclick="submitOrder()">âœ… ç¢ºèªé€å‡ºå…¨éƒ¨è¨‚å–®</button>
      </div>
    </div>
  </div>

  <!-- DONE VIEW -->
  <div id="doneView" class="hidden">
    <div class="done-page">
      <div class="done-icon">âœ…</div>
      <div class="done-title">è¨‚å–®é€å‡ºæˆåŠŸï¼</div>
      <div style="color:#666;margin-bottom:12px;font-size:14px;">è€é—†å·²æ”¶åˆ°æ‚¨çš„è¨‚å–®</div>
      <div class="done-badge" id="doneBadge"></div>
      <div style="font-size:12px;color:#aaa;margin-bottom:16px;">åº—å®¶ç¢ºèªå‰å¯ä»¥ä¿®æ”¹è¨‚å–®</div>
      <button onclick="goLookup()" style="width:100%;max-width:280px;background:#fff;color:var(--blue);border:2px solid var(--blue);border-radius:12px;padding:12px 0;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:12px;">âœï¸ ä¿®æ”¹æˆ‘çš„è¨‚å–®</button>
      <button class="again-btn" onclick="resetAll()">é‡æ–°é–‹å§‹é»é¤ ğŸ±</button>
    </div>
  </div>

  <!-- LOOKUP VIEW -->
  <div id="lookupView" class="hidden">
    <div class="lookup-page">
      <button class="back-btn" onclick="goMenu()">â† è¿”å›é¦–é </button>
      <div class="lookup-box">
        <div class="lookup-title">ğŸ” æŸ¥è©¢ / ä¿®æ”¹è¨‚å–®</div>
        <div style="font-size:13px;color:var(--sub);margin-bottom:14px;">è¼¸å…¥è¨‚è³¼äººå§“åæŸ¥è©¢å¾…ç¢ºèªçš„è¨‚å–®</div>
        <div style="display:flex;gap:8px;">
          <input class="form-input" id="lookupName" placeholder="è«‹è¼¸å…¥è¨‚è³¼äººå§“å" style="flex:1;">
          <button onclick="doLookup()" style="background:var(--red);color:#fff;border:none;border-radius:8px;padding:9px 16px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;">æŸ¥è©¢</button>
        </div>
      </div>
      <div id="lookupResults"></div>
    </div>
  </div>

  <!-- ADMIN VIEW -->
  <div id="adminView" class="hidden">
    <div class="page">
      <div class="page-title">ğŸª å¾Œå°ç®¡ç†</div>
      <div class="admin-tabs">
        <button class="admin-tab active" id="tabOrders" onclick="switchAdminTab('orders')">ğŸ“‹ è¨‚å–®ç®¡ç†</button>
        <button class="admin-tab" id="tabMenu" onclick="switchAdminTab('menu')">ğŸ± èœå–®ç®¡ç†</button>
        <button class="admin-tab" id="tabSettings" onclick="switchAdminTab('settings')">âš™ï¸ è¨­å®š</button>
      </div>

      <!-- Settings Panel -->
      <div id="adminSettings" class="hidden">
        <!-- Active indicator -->
        <div id="activeMenuBanner" style="background:var(--green);color:#fff;border-radius:10px;padding:10px 16px;margin-bottom:12px;font-size:13px;font-weight:700;display:flex;justify-content:space-between;align-items:center;">
          <span id="activeMenuLabel">ç›®å‰ä½¿ç”¨ä¸­ï¼šâ€”</span>
          <div style="display:flex;gap:6px;">
            <button onclick="syncMenuNow()" style="background:rgba(255,255,255,0.25);color:#fff;border:none;border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;">ğŸ“¥ å¾è©¦ç®—è¡¨è¼‰å…¥</button>
            <button onclick="pushMenuToSheets()" style="background:rgba(255,255,255,0.25);color:#fff;border:none;border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;">ğŸ“¤ æ¨é€åˆ°è©¦ç®—è¡¨</button>
          </div>
        </div>
        <div id="gasStatus" style="margin-bottom:8px;font-size:12px;text-align:center;"></div>

        <!-- Slot list -->
        <div id="slotList"></div>

        <!-- Add new slot -->
        <div class="form-box" style="margin-top:8px;">
          <div class="form-title">ï¼‹ æ–°å¢èœå–®é€£çµ</div>
          <div class="form-group">
            <label class="form-label">åç¨±ï¼ˆä¾‹ï¼šåˆé¤èœå–®ã€æ™šé¤èœå–®ï¼‰</label>
            <input class="form-input" id="newSlotName" placeholder="è«‹è¼¸å…¥åç¨±">
          </div>
          <div class="form-group">
            <label class="form-label">Apps Script ç¶²å€</label>
            <input class="form-input" id="newSlotUrl" placeholder="https://script.google.com/macros/s/..." style="font-size:11px;">
          </div>
          <button onclick="addSlot()" style="width:100%;background:var(--red);color:#fff;border:none;border-radius:10px;padding:11px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;">ï¼‹ æ–°å¢</button>
        </div>

        <div class="form-box" style="background:#fffbf0;margin-top:8px;">
          <div class="form-title">ğŸ“‹ è¨­å®šæ­¥é©Ÿ</div>
          <div style="font-size:13px;color:var(--text);line-height:2;">
            <div>â‘  æ‰“é–‹ä½ çš„ Google è©¦ç®—è¡¨</div>
            <div>â‘¡ é»ä¸Šæ–¹é¸å–® <b>ã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€</b></div>
            <div>â‘¢ æŠŠæä¾›çš„ç¨‹å¼ç¢¼è²¼é€²å»ï¼ŒæŒ‰å„²å­˜ ğŸ’¾</div>
            <div>â‘£ é» <b>ã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ã€</b></div>
            <div>â‘¤ é¡å‹é¸ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</div>
            <div>â‘¥ åŸ·è¡Œè€…é¸ã€Œæˆ‘ã€ï¼Œå­˜å–æ¬Šé¸ã€Œæ‰€æœ‰äººã€</div>
            <div>â‘¦ æŒ‰éƒ¨ç½²ï¼Œè¤‡è£½ç¶²å€è²¼åˆ°ä¸Šæ–¹æ¬„ä½</div>
          </div>
        </div>
      </div>

      <!-- Orders Panel -->
      <div id="adminOrders">
        <!-- ç‡Ÿæ¥­ç‹€æ…‹åˆ‡æ› -->
        <div style="display:flex;align-items:center;justify-content:space-between;background:#fff;border-radius:12px;padding:12px 16px;box-shadow:0 2px 6px rgba(0,0,0,0.07);margin-bottom:12px;">
          <div>
            <div style="font-weight:700;font-size:14px;" id="shopStatusLabel">ğŸŸ¢ ç‡Ÿæ¥­ä¸­</div>
            <div style="font-size:11px;color:var(--sub);margin-top:2px;">é¡§å®¢å¯ä»¥é€å‡ºè¨‚å–®</div>
          </div>
          <label style="position:relative;display:inline-block;width:56px;height:30px;cursor:pointer;">
            <input type="checkbox" id="shopStatusToggle" onchange="toggleShopStatus()" style="opacity:0;width:0;height:0;">
            <span id="shopStatusTrack" style="position:absolute;inset:0;border-radius:30px;background:var(--green);transition:background 0.3s;"></span>
            <span id="shopStatusThumb" style="position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;background:#fff;transition:left 0.3s;box-shadow:0 1px 4px rgba(0,0,0,0.2);"></span>
          </label>
        </div>
        <div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
          <button onclick="renderOrderList()" style="background:var(--gray);border:none;border-radius:8px;padding:6px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;color:#555;">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>
        <div class="admin-stats">
          <div class="stat-card" style="border-top:4px solid #f39c12;"><div class="stat-num" style="color:#f39c12;" id="statPending">0</div><div class="stat-label">å¾…ç¢ºèª</div></div>
          <div class="stat-card" style="border-top:4px solid var(--blue);"><div class="stat-num" style="color:var(--blue);" id="statCooking">0</div><div class="stat-label">è£½ä½œä¸­</div></div>
          <div class="stat-card" style="border-top:4px solid var(--green);"><div class="stat-num" style="color:var(--green);" id="statDone">0</div><div class="stat-label">å®Œæˆ</div></div>
        </div>
        <div class="order-cards" id="orderCards"></div>
      </div>

      <!-- Menu Panel -->
      <div id="adminMenu" class="hidden">
        <div class="menu-mgr-header">
          <div style="font-weight:700;color:var(--text);">ç®¡ç†èœå–®å“é …</div>
          <button class="add-item-btn" onclick="openAddModal()">ï¼‹ æ–°å¢å“é …</button>
        </div>
        <div class="mgr-tabs" id="mgrTabs"></div>
        <div id="mgrList"></div>
      </div>
    </div>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<!-- è‡ªè¨‚ç¢ºèªå°è©±æ¡†ï¼ˆå–ä»£ confirm()ï¼‰-->
  <div id="confirmDialog" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;padding:24px;">
    <div style="background:#fff;border-radius:20px;width:100%;max-width:320px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,0.25);">
      <div style="padding:24px 20px 16px;text-align:center;">
        <div style="font-size:32px;margin-bottom:10px;" id="confirmIcon">âš ï¸</div>
        <div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px;" id="confirmTitle">ç¢ºèª</div>
        <div style="font-size:14px;color:var(--sub);line-height:1.6;" id="confirmMsg"></div>
      </div>
      <div style="display:flex;gap:0;border-top:1px solid #eee;">
        <button id="confirmCancelBtn" style="flex:1;background:#fff;border:none;border-right:1px solid #eee;padding:14px;font-size:15px;color:var(--sub);font-weight:600;cursor:pointer;font-family:inherit;border-radius:0 0 0 20px;">å–æ¶ˆ</button>
        <button id="confirmOkBtn" style="flex:1;background:#fff;border:none;padding:14px;font-size:15px;color:var(--red);font-weight:700;cursor:pointer;font-family:inherit;border-radius:0 0 20px 0;">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay hidden" id="modalOverlay">
  <div class="modal">
    <div class="modal-title" id="modalTitle">æ–°å¢å“é …</div>
    <div class="form-group">
      <label class="form-label">åˆ†é¡</label>
      <select class="form-select" id="mCat"></select>
    </div>
    <div class="form-group">
      <label class="form-label">å“é …åç¨± *</label>
      <input class="form-input" id="mName" placeholder="ä¾‹ï¼šæ’éª¨ä¾¿ç•¶">
    </div>
    <div class="form-group">
      <label class="form-label">åƒ¹æ ¼ (NT$) *</label>
      <input class="form-input" id="mPrice" placeholder="ä¾‹ï¼š85" type="number">
    </div>
    <div class="form-group">
      <label class="form-label">æè¿°</label>
      <input class="form-input" id="mDesc" placeholder="ä¾‹ï¼šé…¥ç‚¸æ’éª¨ï¼Œé…æ™‚è”¬ä¸‰æ¨£">
    </div>
    <div class="form-group">
      <label class="form-label">æ¨™ç±¤</label>
      <select class="form-select" id="mTag">
        <option value="">ç„¡</option>
        <option value="ç†±éŠ·">ğŸ”¥ ç†±éŠ·</option>
        <option value="æ¨è–¦">â­ æ¨è–¦</option>
      </select>
    </div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="modal-save" onclick="saveItem()">å„²å­˜</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ Default menu data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_MENU = {
  "ä»Šæ—¥ä¾¿ç•¶":[
    {id:1,name:"æ’éª¨ä¾¿ç•¶",price:85,desc:"é…¥ç‚¸æ’éª¨ï¼Œé…æ™‚è”¬ä¸‰æ¨£",tag:"ç†±éŠ·",active:true},
    {id:2,name:"é›è…¿ä¾¿ç•¶",price:90,desc:"æ»·é›è…¿ï¼Œçš®Qè‚‰å«©",tag:"ç†±éŠ·",active:true},
    {id:3,name:"æ§è‚‰ä¾¿ç•¶",price:90,desc:"å¤æ—©å‘³ç´…ç‡’æ§è‚‰",tag:"",active:true},
    {id:4,name:"é­šæ’ä¾¿ç•¶",price:85,desc:"é¦™ç…é¯›é­šæ’ï¼Œæ¸…çˆ½å°‘æ²¹",tag:"",active:true},
    {id:5,name:"ç´ é£Ÿä¾¿ç•¶",price:75,desc:"è±†è…è”¬èœï¼Œæ¸…æ·¡é¤Šç”Ÿ",tag:"",active:true},
    {id:6,name:"é›™æ‹¼ä¾¿ç•¶",price:110,desc:"æ’éª¨ï¼‹é›è…¿ï¼Œä»½é‡åè¶³",tag:"æ¨è–¦",active:true},
  ],
  "ç†Ÿé£Ÿå°èœ":[
    {id:7,name:"æ»·è›‹",price:10,desc:"å…¥å‘³æ»·è›‹ï¼Œä¸€é¡†",tag:"",active:true},
    {id:8,name:"è±†ä¹¾",price:15,desc:"äº”é¦™è±†ä¹¾ï¼Œä¸‰å¡Š",tag:"",active:true},
    {id:9,name:"æµ·å¸¶",price:15,desc:"æ»·æµ·å¸¶çµï¼Œè»ŸQå…¥å‘³",tag:"",active:true},
    {id:10,name:"èŠ±æ¤°èœ",price:20,desc:"æ¸…ç‚’ç¶ èŠ±æ¤°èœ",tag:"",active:true},
    {id:11,name:"ç‚’é’èœ",price:20,desc:"ç•¶æ—¥æ™‚è”¬ï¼Œå¤§ç«å¿«ç‚’",tag:"",active:true},
    {id:12,name:"ç´…ç‡’è±†è…",price:25,desc:"å«©è±†è…ç´…ç‡’",tag:"",active:true},
    {id:13,name:"ç‚’é«˜éº—èœ",price:20,desc:"è’œé¦™é«˜éº—èœ",tag:"",active:true},
    {id:14,name:"çš®è›‹è±†è…",price:35,desc:"æ¶¼æ‹Œçš®è›‹è±†è…",tag:"",active:true},
  ],
  "æ¹¯å“é£²æ–™":[
    {id:15,name:"å‘³å™Œæ¹¯",price:20,desc:"æ—¥å¼å‘³å™Œæ¹¯ï¼Œæš–èƒƒ",tag:"",active:true},
    {id:16,name:"è›‹èŠ±æ¹¯",price:15,desc:"ç°¡å–®æ¸…æ·¡è›‹èŠ±æ¹¯",tag:"",active:true},
    {id:17,name:"æ’éª¨æ¹¯",price:40,desc:"å¤§éª¨ç†¬è£½ï¼Œé®®ç”œæ¸…çˆ½",tag:"æ¨è–¦",active:true},
    {id:18,name:"ç´«èœæ¹¯",price:15,desc:"ç´«èœè›‹èŠ±æ¹¯",tag:"",active:true},
    {id:19,name:"ç†±è±†æ¼¿",price:20,desc:"ç„¡ç³–/å¾®ç³–",tag:"",active:true},
    {id:20,name:"å†·è±†æ¼¿",price:20,desc:"ç„¡ç³–/å¾®ç³–",tag:"",active:true},
    {id:21,name:"ç´…èŒ¶",price:15,desc:"å°ç£ç´…èŒ¶ï¼Œå»å†°/å°‘å†°",tag:"",active:true},
    {id:22,name:"ç¤¦æ³‰æ°´",price:15,desc:"600ml",tag:"",active:true},
  ],
  "åŠ è³¼é…æ–™":[
    {id:23,name:"åŠ é£¯",price:10,desc:"å¤šåŠ ä¸€ä»½ç™½é£¯",tag:"",active:true},
    {id:24,name:"åŠ èœï¼ˆéš¨æ©Ÿï¼‰",price:20,desc:"ç•¶æ—¥æ™‚è”¬ä¸€ä»½",tag:"",active:true},
    {id:25,name:"ç™½é£¯",price:10,desc:"ä¸€ç¢—ç™½é£¯",tag:"",active:true},
    {id:26,name:"ç³™ç±³é£¯",price:15,desc:"é¤Šç”Ÿç³™ç±³",tag:"",active:true},
    {id:27,name:"è·åŒ…è›‹",price:15,desc:"åŠç†Ÿè·åŒ…è›‹",tag:"",active:true},
    {id:28,name:"æ³¡èœ",price:20,desc:"éŸ“å¼æ³¡èœï¼Œä¸€å°ç¢Ÿ",tag:"",active:true},
    {id:29,name:"æ»·è‚‰ç‡¥",price:20,desc:"æ·‹é£¯ç”¨è‚‰ç‡¥ä¸€ä»½",tag:"",active:true},
    {id:30,name:"åŠ è¾£",price:0,desc:"å…è²»åŠ è¾£é†¬",tag:"",active:true},
  ],
};

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let MENU = JSON.parse(localStorage.getItem('menuData') || 'null') || JSON.parse(JSON.stringify(DEFAULT_MENU));
let SETTINGS = JSON.parse(localStorage.getItem('storeSettings') || '{}');

// Multi-person cart: persons = [{name, isSelf, items:[{id,name,price,qty}]}]
let persons = [];          // confirmed persons in cart
let currentCart = {};      // current person's selections
let currentPersonType = 'self';  // 'self' or 'other'

let activeTab = Object.keys(MENU)[0];
let orders = JSON.parse(localStorage.getItem('orders') || '[]');
let lastOrdererName = '';
let pendingEditIds = [];
let orderCounter = parseInt(localStorage.getItem('orderCounter') || '0');
let adminTab = 'orders';
let mgrTab = Object.keys(MENU)[0];
let nextId = Math.max(...Object.values(MENU).flat().map(i=>i.id), 30) + 1;

function saveMenu(){ localStorage.setItem('menuData', JSON.stringify(MENU)); }

function applySettings(s, showPopup){
  if(!s || !Object.keys(s).length) return;
  const name = s['åº—å'] || 'é˜¿å¬¤çš„ä¾¿ç•¶';
  document.getElementById('storeName').textContent = 'ğŸ± ' + name;
  document.title = name + ' - ç·šä¸Šé»é¤';

  // å¡«å……åº—å®¶è³‡è¨Š Modal å…§å®¹
  const body = document.getElementById('shopInfoBody');
  if(body){
    const rows = [
      { icon:'ğŸª', label:'åº—å',     key:'åº—å' },
      { icon:'ğŸ“¢', label:'å…¬å‘Šè¨Šæ¯', key:'å…¬å‘Šè¨Šæ¯',  highlight:true },
      { icon:'ğŸ•', label:'ç‡Ÿæ¥­æ™‚é–“', key:'ç‡Ÿæ¥­æ™‚é–“' },
      { icon:'ğŸ“', label:'é›»è©±',     key:'åº—å®¶é›»è©±',  isPhone:true },
      { icon:'ğŸ›µ', label:'å¤–é€ç¯„åœ', key:'å¤–é€ç¯„åœ' },
      { icon:'ğŸ’°', label:'æœ€ä½å¤–é€é‡‘é¡', key:'æœ€ä½å¤–é€é‡‘é¡', suffix:' å…ƒ' },
      { icon:'ğŸšš', label:'å¤–é€è²»',   key:'å¤–é€è²»', suffix:' å…ƒ' },
      { icon:'ğŸ’³', label:'ä»˜æ¬¾æ–¹å¼', key:'ä»˜æ¬¾æ–¹å¼' },
    ];
    body.innerHTML = rows.map(function(r){
      const val = s[r.key] || '';
      if(!val) return '';
      const valHtml = r.isPhone
        ? '<a href="tel:' + val.replace(/[-\s()]/g,'') + '" style="color:var(--red);font-weight:700;text-decoration:none;">' + val + '</a>'
        : '<span style="font-weight:700;color:' + (r.highlight?'var(--red)':'var(--text)') + ';">' + val + (r.suffix||'') + '</span>';
      return '<div style="display:flex;align-items:flex-start;gap:12px;padding:12px;background:#fafafa;border-radius:12px;">' +
        '<div style="font-size:22px;width:32px;text-align:center;flex-shrink:0;">' + r.icon + '</div>' +
        '<div><div style="font-size:11px;color:var(--sub);margin-bottom:3px;">' + r.label + '</div>' +
        '<div style="font-size:14px;">' + valHtml + '</div></div></div>';
    }).join('');
  }

  // å…¬å‘Šå½ˆçª—ï¼šåªæœ‰åœ¨ showPopup=true ä¸”æœ‰å…¬å‘Šæ™‚æ‰å½ˆå‡º
  if(showPopup){
    const ann = s['å…¬å‘Šè¨Šæ¯'] || '';
    if(ann){
      const lastAnn = sessionStorage.getItem('lastAnnouncement');
      if(lastAnn !== ann){
        document.getElementById('announcementText').textContent = ann;
        document.getElementById('announcementPopup').style.display = 'flex';
        sessionStorage.setItem('lastAnnouncement', ann);
      }
    }
  }
}

function openShopInfo(){
  document.getElementById('shopInfoModal').style.display = 'flex';
}
function closeShopInfo(){
  document.getElementById('shopInfoModal').style.display = 'none';
}
function closeAnnouncement(){
  document.getElementById('announcementPopup').style.display = 'none';
}
// é»å½ˆçª—èƒŒæ™¯ä¹Ÿå¯é—œé–‰
document.getElementById('shopInfoModal').addEventListener('click', function(e){
  if(e.target === this) closeShopInfo();
});
document.getElementById('announcementPopup').addEventListener('click', function(e){
  if(e.target === this) closeAnnouncement();
});

// â”€â”€ ç‡Ÿæ¥­ç‹€æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let shopIsOpen = localStorage.getItem('shopIsOpen') !== 'false'; // default: open

function applyShopStatus(){
  const banner = document.getElementById('shopClosedBanner');
  const toggle = document.getElementById('shopStatusToggle');
  const label  = document.getElementById('shopStatusLabel');
  const track  = document.getElementById('shopStatusTrack');
  const thumb  = document.getElementById('shopStatusThumb');
  if(toggle){ toggle.checked = shopIsOpen; }
  if(banner){ banner.classList.toggle('hidden', shopIsOpen); }
  if(label)  label.textContent = shopIsOpen ? 'ğŸŸ¢ ç‡Ÿæ¥­ä¸­' : 'ğŸ”´ ä¼‘æ¯ä¸­';
  if(track)  track.style.background = shopIsOpen ? 'var(--green)' : '#ccc';
  if(thumb)  thumb.style.left = shopIsOpen ? '29px' : '3px';
  if(label){
    const sub = label.nextElementSibling;
    if(sub) sub.textContent = shopIsOpen ? 'é¡§å®¢å¯ä»¥é€å‡ºè¨‚å–®' : 'é¡§å®¢ç„¡æ³•é€å‡ºè¨‚å–®';
  }
}

function toggleShopStatus(){
  shopIsOpen = document.getElementById('shopStatusToggle').checked;
  localStorage.setItem('shopIsOpen', shopIsOpen ? 'true' : 'false');
  applyShopStatus();
  showNotif(shopIsOpen ? 'âœ… å·²é–‹å•Ÿç‡Ÿæ¥­ï¼' : 'ğŸ”´ å·²åˆ‡æ›ç‚ºä¼‘æ¯ä¸­');
}

// â”€â”€ å¾ Google è©¦ç®—è¡¨è¼‰å…¥èœå–® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å¤šç­–ç•¥è®€å– GASï¼ˆè‡ªå‹•å˜—è©¦æœ€ä½³æ–¹å¼ï¼‰
async function fetchGAS(url) {
  // åˆ¤æ–· url æ˜¯å¦å·²æœ‰ query stringï¼Œæ±ºå®šç”¨ ? æˆ– &
  const sep = url.indexOf('?') === -1 ? '?' : '&';
  const stamp = sep + 't=' + Date.now();

  // ç­–ç•¥1ï¼šç›´æ¥ fetchï¼ˆé›»è…¦é€šå¸¸å¯è¡Œï¼‰
  try {
    const res = await fetch(url + stamp + '&v=1', { redirect: 'follow' });
    const text = await res.text();
    const json = extractJSON(text);
    if (json && json.success !== undefined) return json;
  } catch(e) { /* ç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹ */ }

  // ç­–ç•¥2ï¼šé€é CORS Proxyï¼ˆæ‰‹æ©Ÿé€šå¸¸éœ€è¦é€™å€‹ï¼‰
  try {
    const proxy = 'https://corsproxy.io/?' + encodeURIComponent(url + stamp + '&v=2');
    const res = await fetch(proxy, { redirect: 'follow' });
    const text = await res.text();
    const json = extractJSON(text);
    if (json && json.success !== undefined) return json;
  } catch(e) { /* ç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹ */ }

  // ç­–ç•¥3ï¼šå‚™ç”¨ CORS Proxy
  try {
    const proxy2 = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url + stamp + '&v=3');
    const res = await fetch(proxy2);
    const wrapper = await res.json();
    const json = extractJSON(wrapper.contents || '');
    if (json && json.success !== undefined) return json;
  } catch(e) { /* å…¨éƒ¨å¤±æ•— */ }

  throw new Error('æ‰€æœ‰é€£ç·šæ–¹å¼çš†å¤±æ•—ï¼Œè«‹ç¢ºèª Apps Script éƒ¨ç½²è¨­å®šæ­£ç¢º');
}

function extractJSON(text) {
  if (!text) return null;
  try { return JSON.parse(text); } catch {}
  const m = text.match(/\{[\s\S]*\}/);
  if (m) { try { return JSON.parse(m[0]); } catch {} }
  return null;
}

async function loadMenuFromSheets(){
  const url = localStorage.getItem('gasUrl');
  if(!url) return;
  try {
    document.getElementById('menuLoading').classList.remove('hidden');
    const data = await fetchGAS(url);
    if(data.success && data.menu && Object.keys(data.menu).length > 0){
      MENU = data.menu;
      activeTab = Object.keys(MENU)[0];
      mgrTab = Object.keys(MENU)[0];
      nextId = Math.max(...Object.values(MENU).flat().map(i=>i.id), 30) + 1;
      localStorage.setItem('menuData', JSON.stringify(MENU));
    }
    if(data.settings){
      SETTINGS = data.settings;
      localStorage.setItem('storeSettings', JSON.stringify(SETTINGS));
      applySettings(SETTINGS);
    }
  } catch(e){
    console.log('è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™', e);
  } finally {
    document.getElementById('menuLoading').classList.add('hidden');
    renderTabs(); renderMenu();
  }
}

// â”€â”€ Person selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPersonType(type){
  currentPersonType = type;
  document.getElementById('btnSelf').classList.toggle('active', type==='self');
  document.getElementById('btnOther').classList.toggle('active', type==='other');
  const input = document.getElementById('currentPersonName');
  input.placeholder = type==='self' ? 'è«‹è¼¸å…¥ä½ çš„å§“å' : 'è«‹è¼¸å…¥å°æ–¹å§“å';
}
function updateCurrentName(){ updateCartUI(); }

// â”€â”€ Menu rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTabs(){
  document.getElementById('tabs').innerHTML = Object.keys(MENU).map(cat=>
    `<button class="tab ${cat===activeTab?'active':''}" onclick="setTab('${cat}')">${cat}</button>`
  ).join('');
}
function setTab(cat){ activeTab=cat; renderTabs(); renderMenu(); }

function renderMenu(){
  const items = (MENU[activeTab]||[]).filter(i=>i.active);
  document.getElementById('menuList').innerHTML = items.length === 0
    ? `<div style="text-align:center;padding:40px 0;color:var(--sub);">æœ¬é¡æš«ç„¡ä¾›æ‡‰å“é …</div>`
    : items.map(item=>{
      const qty = currentCart[item.id]?.qty||0;
      const tag = item.tag ? `<span class="tag ${item.tag==='ç†±éŠ·'?'tag-hot':'tag-rec'}">${item.tag}</span>` : '';
      const minus = qty>0 ? `<button class="ctrl-btn minus-btn" onclick="removeItem(${item.id})">âˆ’</button><span class="item-qty">${qty}</span>` : '';
      const imgHtml = item.imageUrl
        ? `<img class="menu-item-img" src="${item.imageUrl}" alt="${item.name}" loading="lazy" onerror="this.style.display='none'">`
        : '';
      return `<div class="menu-item${item.imageUrl?' has-img':''}">
        ${imgHtml}
        <div class="menu-item-body">
          <div>
            <div class="item-name-row"><span class="item-name">${item.name}</span>${tag}</div>
            <div class="item-desc">${item.desc}</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
            <div class="item-price">${item.price===0?'å…è²»':'NT$ '+item.price}</div>
            <div class="item-controls">${minus}<button class="ctrl-btn plus-btn" onclick="addItem(${item.id})">+</button></div>
          </div>
        </div>
      </div>`;
    }).join('');
}

function findItem(id){ return Object.values(MENU).flat().find(i=>i.id===id); }

function addItem(id){
  const item = findItem(id);
  currentCart[id] = {...item, qty:(currentCart[id]?.qty||0)+1};
  renderMenu(); updateCartUI();
}
function removeItem(id){
  if(!currentCart[id]) return;
  currentCart[id].qty--;
  if(currentCart[id].qty<=0) delete currentCart[id];
  renderMenu(); updateCartUI();
}
function updateCartUI(){
  const curItems = Object.values(currentCart);
  const curCount = curItems.reduce((s,i)=>s+i.qty,0);
  // total persons + current
  const allPersonsCount = persons.reduce((s,p)=>s+p.items.reduce((ss,i)=>ss+i.qty,0),0);
  const totalCount = allPersonsCount + curCount;
  const totalAmt = persons.reduce((s,p)=>s+p.subtotal,0) + curItems.reduce((s,i)=>s+i.price*i.qty,0);

  const badge = document.getElementById('cartBadge');
  badge.textContent = totalCount;
  badge.classList.toggle('hidden', totalCount===0);

  // Show bottom bar if current person has items OR there are already persons in cart
  const showBar = curCount > 0 || persons.length > 0;
  document.getElementById('bottomBar').classList.toggle('hidden', !showBar);
  document.getElementById('bottomTotal').textContent = totalAmt > 0 ? 'NT$ '+totalAmt : '';

  // Person count hint
  const pc = document.getElementById('personCount');
  pc.textContent = persons.length > 0 ? `å·²åŠ å…¥ ${persons.length} äºº` : '';
}

// â”€â”€ Next person â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nextPerson(){
  const name = document.getElementById('currentPersonName').value.trim();
  const curItems = Object.values(currentCart);
  if(!name){ showNotif('è«‹å…ˆè¼¸å…¥å§“åï¼'); return; }
  if(curItems.length===0){ showNotif('è«‹å…ˆé¸æ“‡é¤é»ï¼'); return; }
  const subtotal = curItems.reduce((s,i)=>s+i.price*i.qty,0);
  const personData = {
    name: name,
    isSelf: currentPersonType==='self',
    items: curItems.map(i=>({id:i.id,name:i.name,price:i.price,qty:i.qty})),
    subtotal: subtotal,
  };

  // å¦‚æœæ˜¯å¾ã€Œä¿®æ”¹ç¾æœ‰è¨‚å–®ã€æ¨¡å¼é€²ä¾†çš„
  if(window._isEditingExisting && window._editingPersonIdx !== undefined){
    editingOrders[window._editingPersonIdx] = personData;
    window._isEditingExisting = false;
    window._editingPersonIdx = undefined;
    currentCart = {};
    document.getElementById('currentPersonName').value = '';
    setPersonType('other');
    renderMenu(); updateCartUI();
    // å›åˆ°ä¿®æ”¹è¨‚å–®é¸å–®
    hide('menuView');
    show('lookupView');
    renderEditOrdersPage();
    showNotif('âœ… ' + name + ' çš„é¤é»å·²æ›´æ–°ï¼');
    return;
  }

  // ä¸€èˆ¬æ–°å¢æ¨¡å¼
  persons.push(personData);
  currentCart = {};
  document.getElementById('currentPersonName').value = '';
  setPersonType('other');
  renderMenu();
  updateCartUI();
  showNotif('âœ… ' + name + ' çš„é¤é»å·²åŠ å…¥ï¼');
}



// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetAll(){
  persons=[]; currentCart={};
  document.getElementById('currentPersonName').value='';
  setPersonType('self');
  updateCartUI(); renderMenu();
  goMenu();
}
function goMenu(){
  show('menuView'); hide('cartView'); hide('doneView'); hide('adminView'); hide('lookupView');
  document.getElementById('adminBtn').classList.remove('active');
}
function goCart(){
  // è‹¥ç›®å‰æœ‰é¸é¤ä½†é‚„æ²’æŒ‰ã€Œä¸‹ä¸€ä½ã€ï¼Œè©¢å•æ˜¯å¦å…ˆåŠ å…¥
  const curItems = Object.values(currentCart);
  const curName = document.getElementById('currentPersonName').value.trim();
  if(curItems.length > 0 && curName){
    customConfirm('ğŸ›’ åŠ å…¥è³¼ç‰©è»Š', 'è¦å…ˆæŠŠã€Œ' + curName + 'ã€çš„é¤é»åŠ å…¥è³¼ç‰©è»Šå—ï¼Ÿ', function(){
      nextPerson();
      hide('menuView'); show('cartView'); hide('doneView'); hide('adminView');
      renderCartView();
    });
    return;
  }
  hide('menuView'); show('cartView'); hide('doneView'); hide('adminView');
  renderCartView();
}

function renderCartView(){
  // æ¯æ¬¡é€²å…¥è³¼ç‰©è»Šéƒ½é‡ç½®é€å‡ºæŒ‰éˆ•ï¼ˆé˜²æ­¢ä¸Šæ¬¡ disabled ç‹€æ…‹æ®˜ç•™ï¼‰
  const btn = document.getElementById('submitBtn');
  if(btn){ btn.disabled = false; btn.textContent = 'âœ… ç¢ºèªé€å‡ºå…¨éƒ¨è¨‚å–®'; }

  if(persons.length === 0){
    show('cartEmpty'); hide('cartContent'); return;
  }
  hide('cartEmpty'); show('cartContent');

  document.getElementById('personGroups').innerHTML = persons.map(function(p, idx){
    const label = p.isSelf ? 'ğŸ™‹ è‡ªå·±' : 'ğŸ‘« ä»£è¨‚';
    return '<div class="person-group">' +
      '<div class="person-group-header">' +
        '<span class="person-group-name">' + label + 'ã€€' + p.name + '</span>' +
        '<span class="person-group-subtotal">NT$ ' + p.subtotal + '</span>' +
      '</div>' +
      '<div class="person-group-body">' +
        p.items.map(function(i){
          return '<div class="person-item-row">' +
            '<span class="person-item-name">' + i.name + ' Ã— ' + i.qty + '</span>' +
            '<span class="person-item-price">NT$ ' + (i.price * i.qty) + '</span>' +
          '</div>';
        }).join('') +
        '<div style="padding:4px 16px 8px;display:flex;justify-content:flex-end;gap:8px;">' +
          '<button onclick="editPerson(' + idx + ')" style="font-size:11px;color:var(--blue);background:#eaf4ff;border:none;border-radius:6px;padding:5px 12px;cursor:pointer;font-weight:700;">âœï¸ ä¿®æ”¹</button>' +
          '<button onclick="removePerson(' + idx + ')" style="font-size:11px;color:#aaa;background:none;border:1px solid #eee;border-radius:6px;padding:5px 10px;cursor:pointer;">ç§»é™¤æ­¤äºº</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');

  const grandTotal = persons.reduce(function(s,p){ return s + p.subtotal; }, 0);
  document.getElementById('grandTotalRows').innerHTML = persons.map(function(p){
    return '<div class="grand-total-row"><span>' + p.name + '</span><span>NT$ ' + p.subtotal + '</span></div>';
  }).join('');
  document.getElementById('grandTotal').textContent = grandTotal;
}

function removePerson(idx){
  persons.splice(idx, 1);
  updateCartUI();
  renderCartView();
}

function editPerson(idx){
  const p = persons[idx];
  // æŠŠæ­¤äººè³‡æ–™è¼‰å›é»é¤ç•«é¢
  currentCart = {};
  p.items.forEach(function(i){
    const menuItem = findItem(i.id);
    if(menuItem){
      currentCart[i.id] = Object.assign({}, menuItem, { qty: i.qty });
    } else {
      // è‹¥èœå–®å·²æ›´æ–°ï¼Œä»ç›¡é‡ä¿ç•™
      currentCart[i.id] = { id: i.id, name: i.name, price: i.price, qty: i.qty };
    }
  });
  // è¨­å®šå§“åèˆ‡é¡å‹
  document.getElementById('currentPersonName').value = p.name;
  setPersonType(p.isSelf ? 'self' : 'other');
  // å¾ persons ç§»é™¤ï¼ˆä¿®æ”¹å®Œå†æŒ‰ä¸‹ä¸€ä½é‡æ–°åŠ å…¥ï¼‰
  persons.splice(idx, 1);
  updateCartUI();
  renderMenu();
  // å›åˆ°é»é¤ç•«é¢
  goMenu();
  showNotif('è«‹ä¿®æ”¹ã€Œ' + p.name + 'ã€çš„é¤é»ï¼Œå®Œæˆå¾ŒæŒ‰ã€Œï¼‹ ä¸‹ä¸€ä½ã€');
}

async function submitOrder(){
  if(!shopIsOpen){ showNotif('ç›®å‰ä¼‘æ¯ä¸­ï¼Œæš«åœæ¥å—è¨‚å–®ï¼'); return; }
  if(persons.length === 0){ showNotif('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼è«‹å…ˆåŠ å…¥é¤é»'); return; }
  // é˜²é€£é»ï¼šç«‹å³ç¦ç”¨æŒ‰éˆ•
  const btn = document.getElementById('submitBtn');
  if(btn){ btn.disabled = true; btn.textContent = 'â³ é€å‡ºä¸­...'; }

  const time = document.getElementById('inputTime').value;
  const note = document.getElementById('inputNote').value;
  const selfPerson = persons.find(function(p){ return p.isSelf; });
  const now = new Date().toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'});

  // å…ˆå»ºç«‹æ‰€æœ‰è¨‚å–®ä¸¦å­˜æœ¬åœ°
  const newOrders = persons.map(function(p){
    orderCounter++;
    return {
      id: 'A' + String(orderCounter).padStart(3,'0'),
      name: selfPerson ? selfPerson.name : p.name,
      recipient: p.isSelf ? '' : p.name,
      note: note,
      time: time,
      total: p.subtotal,
      items: p.items.map(function(i){ return {name:i.name, qty:i.qty}; }),
      status: 'å¾…ç¢ºèª',
      createdAt: now,
    };
  });

  newOrders.forEach(function(o){ orders.unshift(o); });
  localStorage.setItem('orders', JSON.stringify(orders));
  localStorage.setItem('orderCounter', String(orderCounter));

  // åˆ‡æ›åˆ°å®Œæˆç•«é¢ï¼ˆä¸ç­‰ç¶²è·¯ï¼Œä½¿ç”¨è€…é«”é©—ä¸å—å½±éŸ¿ï¼‰
  const selfP = persons.find(function(p){ return p.isSelf; });
  if(selfP) lastOrdererName = selfP.name;
  const names = persons.map(function(p){ return p.name; }).join('ã€');
  document.getElementById('doneBadge').textContent = names + 'ã€€å–é¤æ™‚é–“ï¼š' + time;
  persons = []; currentCart = {};
  document.getElementById('currentPersonName').value = '';
  setPersonType('self');
  updateCartUI(); renderMenu();
  document.getElementById('inputNote').value = '';
  hide('cartView'); show('doneView');

  // ä¾åºé€å‡ºæ¯ç­†è¨‚å–®åˆ°è©¦ç®—è¡¨ï¼ˆé–“éš” 300msï¼Œé¿å…åŒæ™‚ç™¼é€éºæ¼ï¼‰
  for(var i = 0; i < newOrders.length; i++){
    await sendToSheets(newOrders[i]);
    if(i < newOrders.length - 1){
      await new Promise(function(r){ setTimeout(r, 300); });
    }
  }
}

const ADMIN_PASSWORD = '1234'; // â† ä½ å¯ä»¥æ”¹æˆè‡ªå·±çš„å¯†ç¢¼
let adminUnlocked = false;
let gasUrl = localStorage.getItem('gasUrl') || '';
// Menu slots: [{name, url}], max 10
var menuSlots = JSON.parse(localStorage.getItem('menuSlots') || '[]');
var activeSlotIndex = parseInt(localStorage.getItem('activeSlotIndex') || '-1');

function saveSlots(){
  localStorage.setItem('menuSlots', JSON.stringify(menuSlots));
  localStorage.setItem('activeSlotIndex', String(activeSlotIndex));
}

function addSlot(){
  const name = document.getElementById('newSlotName').value.trim();
  const url  = document.getElementById('newSlotUrl').value.trim();
  if(!name){ showNotif('è«‹è¼¸å…¥åç¨±ï¼'); return; }
  if(!url){ showNotif('è«‹è²¼ä¸Š Apps Script ç¶²å€ï¼'); return; }
  if(menuSlots.length >= 10){ showNotif('æœ€å¤šåªèƒ½å„²å­˜ 10 çµ„ï¼'); return; }
  menuSlots.push({ name, url });
  document.getElementById('newSlotName').value = '';
  document.getElementById('newSlotUrl').value = '';
  saveSlots();
  renderSlots();
  showNotif('âœ… å·²æ–°å¢ã€Œ' + name + 'ã€ï¼');
}

function useSlot(idx){
  activeSlotIndex = idx;
  gasUrl = menuSlots[idx].url;
  localStorage.setItem('gasUrl', gasUrl);
  saveSlots();
  renderSlots();
  showNotif('å·²åˆ‡æ›åˆ°ã€Œ' + menuSlots[idx].name + 'ã€ï¼Œæ­£åœ¨åŒæ­¥èœå–®...');
  syncMenuNow();
}

function deleteSlot(idx){
  customConfirm('ğŸ—‘ åˆªé™¤é€£çµ', 'ç¢ºå®šåˆªé™¤ã€Œ' + menuSlots[idx].name + 'ã€å—ï¼Ÿ', function(){
    if(activeSlotIndex === idx){
      activeSlotIndex = -1;
      gasUrl = '';
      localStorage.removeItem('gasUrl');
    } else if(activeSlotIndex > idx){
      activeSlotIndex--;
    }
    menuSlots.splice(idx, 1);
    saveSlots();
    renderSlots();
    showNotif('å·²åˆªé™¤ï¼');
  });
}

function editSlotName(idx){
  const newName = prompt('ä¿®æ”¹åç¨±ï¼š', menuSlots[idx].name);
  if(!newName || !newName.trim()) return;
  menuSlots[idx].name = newName.trim();
  saveSlots();
  renderSlots();
}

function renderSlots(){
  const el = document.getElementById('slotList');
  if(!el) return;
  const active = activeSlotIndex;
  const activeName = active >= 0 && menuSlots[active] ? menuSlots[active].name : 'ï¼ˆæœªè¨­å®šï¼‰';
  document.getElementById('activeMenuLabel').textContent = 'ç›®å‰ä½¿ç”¨ä¸­ï¼š' + activeName;

  if(menuSlots.length === 0){
    el.innerHTML = '<div style="text-align:center;padding:20px 0;color:var(--sub);font-size:13px;">å°šæœªæ–°å¢ä»»ä½•èœå–®é€£çµ<br>æœ€å¤šå¯å„²å­˜ 10 çµ„</div>';
    return;
  }
  el.innerHTML = menuSlots.map(function(s, i){
    const isActive = i === active;
    return '<div class="slot-card ' + (isActive ? 'active-slot' : '') + '">' +
      '<div class="slot-card-top">' +
        '<span class="slot-name">' + (i+1) + '. ' + s.name + '</span>' +
        (isActive ? '<span class="slot-active-badge">âœ… ä½¿ç”¨ä¸­</span>' : '') +
      '</div>' +
      '<div class="slot-url">' + s.url.substring(0,60) + '...</div>' +
      '<div class="slot-btns">' +
        '<button class="slot-use-btn ' + (isActive?'is-active':'') + '" onclick="useSlot(' + i + ')">' +
          (isActive ? 'âœ… ä½¿ç”¨ä¸­' : 'â–¶ åˆ‡æ›ä½¿ç”¨') + '</button>' +
        '<button class="slot-edit-btn" onclick="editSlotName(' + i + ')">âœï¸</button>' +
        '<button class="slot-del-btn" onclick="deleteSlot(' + i + ')">ğŸ—‘</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function toggleAdmin(){
  if(!document.getElementById('adminView').classList.contains('hidden')){ goMenu(); return; }
  if(!adminUnlocked){
    const pw = prompt('è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š');
    if(pw === null) return;
    if(pw !== ADMIN_PASSWORD){ showNotif('å¯†ç¢¼éŒ¯èª¤ï¼'); return; }
    adminUnlocked = true;
  }
  hide('menuView'); hide('cartView'); hide('doneView'); show('adminView');
  document.getElementById('adminBtn').classList.add('active');
  renderAdmin();
}

// saveGasUrl replaced by slot system

async function syncMenuNow(){
  const url = localStorage.getItem('gasUrl');
  if(!url){ showNotif('è«‹å…ˆå„²å­˜è©¦ç®—è¡¨é€£çµï¼'); return; }
  const status = document.getElementById('gasStatus');
  status.style.color = 'var(--sub)';
  status.textContent = 'ğŸ”„ åŒæ­¥ä¸­...';
  try {
    const data = await fetchGAS(url);
    if(data.success && data.menu){
      MENU = data.menu;
      activeTab = Object.keys(MENU)[0];
      mgrTab = Object.keys(MENU)[0];
      nextId = Math.max(...Object.values(MENU).flat().map(i=>i.id), 30) + 1;
      localStorage.setItem('menuData', JSON.stringify(MENU));
      renderTabs(); renderMenu(); renderMgrMenu();
      if(data.settings){
        SETTINGS = data.settings;
        localStorage.setItem('storeSettings', JSON.stringify(SETTINGS));
        applySettings(SETTINGS, true);
      }
      status.style.color = 'var(--green)';
      status.textContent = 'âœ… åŒæ­¥æˆåŠŸï¼å…± ' + Object.values(MENU).flat().length + ' å€‹å“é …';
      showNotif('èœå–®èˆ‡åº—å®¶è³‡è¨Šå·²æ›´æ–°ï¼');
    } else {
      status.style.color = 'var(--red)';
      status.textContent = 'âŒ åŒæ­¥å¤±æ•—ï¼š' + (data.error || 'è«‹ç¢ºèªè©¦ç®—è¡¨å·¥ä½œè¡¨åç¨±ç‚ºã€Œèœå–® Menuã€');
    }
  } catch(e){
    status.style.color = 'var(--red)';
    status.textContent = 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message;
    console.error(e);
  }
}

async function syncMenuToSheets(){
  // æ”¹ç”¨ GET + åƒæ•¸å‚³é€ï¼Œè·Ÿ fetchGAS è®€å–æ–¹å¼å®Œå…¨ä¸€è‡´ï¼Œä¸å— CORS / POST å•é¡Œå½±éŸ¿
  const url = localStorage.getItem('gasUrl');
  if(!url) return;
  const menuJson = btoa(unescape(encodeURIComponent(JSON.stringify(MENU)))); // base64 ç·¨ç¢¼
  const sep = url.indexOf('?') === -1 ? '?' : '&';
  const reqUrl = url + sep + 'action=updateMenu&menu=' + encodeURIComponent(menuJson) + '&t=' + Date.now();
  try {
    const result = await fetchGAS(reqUrl);
    if(result && result.success){
      console.log('èœå–®å·²åŒæ­¥åˆ°è©¦ç®—è¡¨ï¼Œå…±', result.count, 'é …');
    }
  } catch(e){ console.log('syncMenuToSheets failed', e); }
}

async function pushMenuToSheets(){
  const status = document.getElementById('gasStatus');
  if(status){ status.style.color='var(--sub)'; status.textContent='ğŸ“¤ æ¨é€èœå–®ä¸­...'; }
  try {
    await syncMenuToSheets();
    if(status){ status.style.color='var(--green)'; status.textContent='âœ… èœå–®å·²æ¨é€åˆ°è©¦ç®—è¡¨ï¼'; }
    showNotif('âœ… èœå–®å·²æ¨é€åˆ°è©¦ç®—è¡¨ï¼');
  } catch(e){
    if(status){ status.style.color='var(--red)'; status.textContent='âŒ æ¨é€å¤±æ•—'; }
  }
}

async function sendToSheets(order){
  if(!gasUrl) return;
  const body = JSON.stringify({
    id: order.id,
    name: order.name,
    recipient: order.recipient||'',
    items: order.items.map(function(i){ return i.name+'Ã—'+i.qty; }).join('ã€'),
    note: order.note||'',
    time: order.time,
    total: order.total,
    createdAt: order.createdAt,
  });
  // ç­–ç•¥1: text/plainï¼ˆno-cors ä¸‹ç€è¦½å™¨å…è¨±å‚³ bodyï¼ŒGAS å¯æ­£å¸¸è§£æï¼‰
  try {
    await fetch(gasUrl, {
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'text/plain'},
      body: body,
    });
    return;
  } catch(e){}
  // ç­–ç•¥2: é€é proxyï¼ˆæ‰‹æ©Ÿç¶²è·¯ç•°å¸¸æ™‚å‚™ç”¨ï¼‰
  try {
    await fetch('https://corsproxy.io/?' + encodeURIComponent(gasUrl), {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: body,
    });
  } catch(e){ console.log('sendToSheets failed', e); }
}

// â”€â”€ Admin: Orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STATUS_COLOR={'å¾…ç¢ºèª':'#f39c12','è£½ä½œä¸­':'#2980b9','å®Œæˆ':'#27ae60'};
const NEXT={'å¾…ç¢ºèª':'è£½ä½œä¸­','è£½ä½œä¸­':'å®Œæˆ','å®Œæˆ':'å®Œæˆ'};

function switchAdminTab(tab){
  adminTab=tab;
  document.getElementById('tabOrders').classList.toggle('active',tab==='orders');
  document.getElementById('tabMenu').classList.toggle('active',tab==='menu');
  document.getElementById('tabSettings').classList.toggle('active',tab==='settings');
  document.getElementById('adminOrders').classList.toggle('hidden',tab!=='orders');
  document.getElementById('adminMenu').classList.toggle('hidden',tab!=='menu');
  document.getElementById('adminSettings').classList.toggle('hidden',tab!=='settings');
  if(tab==='orders') renderOrderList();
  if(tab==='menu') renderMgrMenu();
  if(tab==='settings'){
    renderSlots();
    const s = document.getElementById('gasStatus');
    if(gasUrl){ s.style.color='var(--green)'; s.textContent=''; }
  }
}

function renderAdmin(){
  applyShopStatus();
  renderOrderList();
  if(adminTab==='menu') renderMgrMenu();
}

// sheetsOrders = å¾è©¦ç®—è¡¨è®€ä¾†çš„è¨‚å–®ï¼ˆå¾Œå°ç”¨ï¼‰
var sheetsOrders = [];

function renderOrderList(){
  const el = document.getElementById('orderCards');
  el.innerHTML = '<div class="no-orders" style="padding:30px 0;">ğŸ”„ è¼‰å…¥ä¸­...</div>';
  loadOrdersFromSheets();
}

async function loadOrdersFromSheets(){
  const url = localStorage.getItem('gasUrl');
  if(!url){
    document.getElementById('orderCards').innerHTML = '<div class="no-orders">è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å…¥è©¦ç®—è¡¨é€£çµ</div>';
    return;
  }
  try {
    const data = await fetchGAS(url + '?type=orders');
    if(data.success){
      sheetsOrders = data.orders || [];
      renderOrderCards();
    } else {
      document.getElementById('orderCards').innerHTML = '<div class="no-orders">âŒ è¼‰å…¥å¤±æ•—ï¼š' + (data.error||'') + '</div>';
    }
  } catch(e) {
    document.getElementById('orderCards').innerHTML = '<div class="no-orders">âŒ ç„¡æ³•é€£ç·šè©¦ç®—è¡¨</div>';
  }
}

function renderOrderCards(){
  const orders = sheetsOrders;
  document.getElementById('statPending').textContent = orders.filter(o=>o.status==='å¾…ç¢ºèª').length;
  document.getElementById('statCooking').textContent = orders.filter(o=>o.status==='è£½ä½œä¸­').length;
  document.getElementById('statDone').textContent    = orders.filter(o=>o.status==='å®Œæˆ').length;
  if(orders.length===0){
    document.getElementById('orderCards').innerHTML = '<div class="no-orders">ğŸ“‹ é‚„æ²’æœ‰è¨‚å–®</div>';
    return;
  }
  document.getElementById('orderCards').innerHTML = orders.slice().reverse().map(function(o){
    const color = STATUS_COLOR[o.status] || '#888';
    const nextStatus = NEXT[o.status];
    const nextBtn = o.status !== 'å®Œæˆ'
      ? '<button class="next-btn" style="background:' + STATUS_COLOR[nextStatus] + '" onclick="updateStatus(\'' + o.id + '\')">â†’ ' + nextStatus + '</button>'
      : '<span style="font-size:11px;color:#27ae60;">âœ… å®Œæˆ</span>';
    const recipientBadge = o.recipient
      ? '<span class="order-type-badge badge-delivery">ğŸ‘¤ è¨‚çµ¦ï¼š' + o.recipient + '</span>' : '';
    return '<div class="order-card">' +
      '<div class="order-card-top">' +
        '<div style="display:flex;align-items:center;gap:8px;"><span class="order-id">#' + o.id + '</span>' + recipientBadge + '</div>' +
        '<span class="status-badge" style="background:' + color + '22;color:' + color + '">' + o.status + '</span>' +
      '</div>' +
      '<div class="order-customer">' + o.name + '</div>' +
      '<div class="order-items-text">' + o.items.map(function(i){ return i.name + 'Ã—' + i.qty; }).join('ã€') + (o.note ? 'ã€€å‚™è¨»ï¼š' + o.note : '') + '</div>' +
      '<div class="order-card-bottom">' +
        '<span class="order-time">â° ' + o.time + 'ã€€' + o.createdAt + '</span>' +
        '<div class="order-right"><span class="order-total">NT$ ' + o.total + '</span>' + nextBtn + '</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

async function updateStatus(id){
  const url = localStorage.getItem('gasUrl');
  if(!url){ showNotif('è«‹å…ˆè¨­å®šè©¦ç®—è¡¨é€£çµï¼'); return; }
  const o = sheetsOrders.find(function(o){ return o.id === id; });
  if(!o || o.status === 'å®Œæˆ') return;
  const newStatus = NEXT[o.status];
  try {
    await fetch(url, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'updateStatus', id: id, status: newStatus }),
    });
    o.status = newStatus;
    renderOrderCards();
    showNotif('è¨‚å–®å·²æ›´æ–°ç‚ºï¼š' + newStatus);
  } catch(e) {
    showNotif('æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦');
  }
}

// â”€â”€ Admin: Menu Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMgrMenu(){
  // tabs
  document.getElementById('mgrTabs').innerHTML=Object.keys(MENU).map(cat=>
    `<button class="mgr-tab ${cat===mgrTab?'active':''}" onclick="setMgrTab('${cat}')">${cat}</button>`
  ).join('');
  // items
  const items=MENU[mgrTab]||[];
  document.getElementById('mgrList').innerHTML=items.length===0
    ? `<div style="text-align:center;padding:30px 0;color:var(--sub);">æ­¤åˆ†é¡å°šç„¡å“é …</div>`
    : items.map(item=>`
      <div class="mgr-item" data-item-id="${item.id}">
        <div class="mgr-item-info">
          <div class="mgr-item-name">${item.name} ${item.tag?`<span class="tag ${item.tag==='ç†±éŠ·'?'tag-hot':'tag-rec'}" style="font-size:9px;">${item.tag}</span>`:''}</div>
          <div class="mgr-item-sub">NT$ ${item.price}ã€€${item.desc}</div>
        </div>
        <div class="mgr-item-actions">
          <button class="toggle-btn ${item.active?'toggle-on':'toggle-off'}" onclick="toggleItem(${item.id})">
            ${item.active?'âœ… ä¾›æ‡‰ä¸­':'â¸ å·²ä¸‹æ¶'}
          </button>
          <button class="delete-btn" onclick="deleteItem(${item.id})">ğŸ—‘</button>
        </div>
      </div>`
    ).join('');
}

function setMgrTab(cat){ mgrTab=cat; renderMgrMenu(); }

function toggleItem(id){
  const item=Object.values(MENU).flat().find(i=>i.id===id);
  if(item){ item.active=!item.active; saveMenu(); renderMgrMenu(); renderMenu(); syncMenuToSheets(); showNotif(item.active?'å“é …å·²ä¸Šæ¶ï¼':'å“é …å·²ä¸‹æ¶ï¼'); }
}

function deleteItem(id){
  customConfirm('ğŸ—‘ åˆªé™¤å“é …', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹å“é …å—ï¼Ÿ', function(){
    // â‘  å…ˆç›´æ¥å¾ DOM ç§»é™¤å¡ç‰‡ï¼ˆç«‹å³è¦–è¦ºåé¥‹ï¼Œä¸ä¾è³´é‡æ–°æ¸²æŸ“ï¼‰
    const el = document.querySelector('[data-item-id="' + id + '"]');
    if(el) el.remove();

    // â‘¡ æ›´æ–° MENU è³‡æ–™ï¼ˆç”¨ Number() ç¢ºä¿ id å‹åˆ¥ä¸€è‡´ï¼Œé¿å… "5" !== 5 çš„å•é¡Œï¼‰
    const nid = Number(id);
    for(const cat of Object.keys(MENU)){
      MENU[cat] = MENU[cat].filter(function(i){ return Number(i.id) !== nid; });
    }
    if(!MENU[mgrTab] || MENU[mgrTab].length === 0){
      mgrTab = Object.keys(MENU).find(function(k){ return MENU[k].length > 0; }) || Object.keys(MENU)[0];
      renderMgrMenu(); // åªæœ‰æ› tab æ™‚æ‰é‡æ–°æ¸²æŸ“
    }
    delete currentCart[id];
    saveMenu();
    updateCartUI();
    renderMenu();
    syncMenuToSheets();
    showNotif('âœ… å“é …å·²åˆªé™¤ï¼');
  });
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddModal(){
  document.getElementById('modalTitle').textContent='æ–°å¢å“é …';
  document.getElementById('mCat').innerHTML=Object.keys(MENU).map(c=>`<option>${c}</option>`).join('');
  document.getElementById('mCat').value=mgrTab;
  ['mName','mDesc'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mPrice').value='';
  document.getElementById('mTag').value='';
  show('modalOverlay');
}

function closeModal(){ hide('modalOverlay'); }

function saveItem(){
  const name=document.getElementById('mName').value.trim();
  const price=parseInt(document.getElementById('mPrice').value);
  const cat=document.getElementById('mCat').value;
  if(!name){ showNotif('è«‹è¼¸å…¥å“é …åç¨±ï¼'); return; }
  if(isNaN(price)||price<0){ showNotif('è«‹è¼¸å…¥æ­£ç¢ºåƒ¹æ ¼ï¼'); return; }
  const item={
    id:nextId++, name, price,
    desc:document.getElementById('mDesc').value.trim(),
    tag:document.getElementById('mTag').value,
    active:true,
  };
  if(!MENU[cat]) MENU[cat]=[];
  MENU[cat].push(item);
  saveMenu(); closeModal(); renderMenu(); renderMgrMenu(); syncMenuToSheets();
  showNotif('å“é …æ–°å¢æˆåŠŸï¼Œè©¦ç®—è¡¨åŒæ­¥ä¸­ï¼ğŸ‰');
}

// â”€â”€ Order Lookup & Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goLookup(){
  hide('menuView'); hide('cartView'); hide('doneView'); hide('adminView'); hide('lookupView');
  show('lookupView');
  document.getElementById('lookupResults').innerHTML = '';
  // Pre-fill last known name for convenience
  document.getElementById('lookupName').value = lastOrdererName || '';
}

async function doLookup(){
  const name = document.getElementById('lookupName').value.trim();
  if(!name){ showNotif('è«‹è¼¸å…¥å§“åï¼'); return; }

  const resultsEl = document.getElementById('lookupResults');
  resultsEl.innerHTML = '<div style="text-align:center;padding:30px 0;color:var(--sub);">ğŸ”„ æŸ¥è©¢ä¸­...</div>';

  // æ¯æ¬¡æŸ¥è©¢éƒ½å¾è©¦ç®—è¡¨æ‹‰æœ€æ–°è³‡æ–™ï¼Œé¿å…é¡¯ç¤ºå·²åˆªé™¤çš„èˆŠè¨‚å–®
  const url = localStorage.getItem('gasUrl');
  var freshOrders = [];
  if(url){
    try {
      const data = await fetchGAS(url + '?type=orders');
      if(data.success) freshOrders = data.orders || [];
    } catch(e) {
      // è©¦ç®—è¡¨è®€ä¸åˆ°æ™‚ï¼Œç”¨æœ¬åœ°å¿«å–
      freshOrders = sheetsOrders.length > 0 ? sheetsOrders : orders;
    }
  } else {
    freshOrders = orders;
  }

  // åªé¡¯ç¤ºã€Œå¾…ç¢ºèªã€ä¸”è¨‚è³¼äººåç¨±ç¬¦åˆçš„
  const matched = freshOrders.filter(function(o){
    return o.status === 'å¾…ç¢ºèª' && o.name === name;
  });

  if(matched.length === 0){
    resultsEl.innerHTML = '<div style="text-align:center;padding:40px 0;color:var(--sub);"><div style="font-size:36px;margin-bottom:8px;">ğŸ”</div><div>æ‰¾ä¸åˆ°å¾…ç¢ºèªçš„è¨‚å–®</div><div style="font-size:12px;margin-top:6px;">å¯èƒ½å·²è¢«åº—å®¶ç¢ºèªï¼Œæˆ–å§“åä¸ç¬¦</div></div>';
    return;
  }

  // å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼ˆåŒæ™‚æ›´æ–° sheetsOrders å¿«å–ï¼‰
  sheetsOrders = freshOrders;
  pendingEditIds = matched.map(function(o){ return o.id; });

  resultsEl.innerHTML = matched.map(function(o){
    const recipientLabel = o.recipient ? 'ä»£è¨‚çµ¦ï¼š' + o.recipient : 'è‡ªå·±çš„';
    return '<div class="lookup-result">' +
      '<div class="lookup-result-header">' +
        '<span class="lookup-result-id">#' + o.id + 'ã€€' + recipientLabel + '</span>' +
        '<span class="lookup-result-status" style="background:#fff8e6;color:#f39c12">å¾…ç¢ºèª</span>' +
      '</div>' +
      '<div class="lookup-result-body">' +
        o.items.map(function(i){ return '<div class="lookup-result-row"><span>' + i.name + ' Ã— ' + i.qty + '</span></div>'; }).join('') +
        '<div style="display:flex;justify-content:space-between;border-top:1px dashed #eee;margin-top:6px;padding-top:6px;">' +
          '<span style="color:var(--sub);font-size:12px;">å–é¤æ™‚é–“ï¼š' + o.time + '</span>' +
          '<span style="font-weight:900;color:var(--red);">NT$ ' + o.total + '</span>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('') +
  '<button class="lookup-edit-btn" onclick="startEditOrders()">âœï¸ ä¿®æ”¹é€™äº›è¨‚å–®</button>';
}

// å­˜æ”¾å¾è©¦ç®—è¡¨è¼‰å›ã€ç­‰å¾…ç·¨è¼¯çš„è¨‚å–®
var editingOrders = [];

async function startEditOrders(){
  var orderIds = pendingEditIds;
  if(!orderIds || orderIds.length === 0) return;

  var allOrders = sheetsOrders.length > 0 ? sheetsOrders : orders;
  var matchedOrders = allOrders.filter(function(o){ return orderIds.indexOf(o.id) !== -1; });
  if(matchedOrders.length === 0){ showNotif('æ‰¾ä¸åˆ°è¨‚å–®ï¼Œè«‹é‡æ–°æŸ¥è©¢'); return; }

  showNotif('è¼‰å…¥ä¸­...');

  // å¾è©¦ç®—è¡¨åˆªé™¤èˆŠè¨‚å–®
  var url = localStorage.getItem('gasUrl');
  if(url){
    for(var d = 0; d < matchedOrders.length; d++){
      try {
        await fetch(url, {
          method: 'POST', mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'deleteOrder', id: matchedOrders[d].id }),
        });
      } catch(e) {}
    }
  }

  // å¾æœ¬åœ°ç§»é™¤
  orders = orders.filter(function(o){ return orderIds.indexOf(o.id) === -1; });
  sheetsOrders = sheetsOrders.filter(function(o){ return orderIds.indexOf(o.id) === -1; });
  localStorage.setItem('orders', JSON.stringify(orders));

  // ç”¨å“é …åç¨±å¾èœå–®æŸ¥å›æ­£ç¢ºå–®åƒ¹
  var allMenuItems = Object.values(MENU).flat();
  editingOrders = matchedOrders.map(function(o){
    var isSelf = !o.recipient;
    var personName = o.recipient ? o.recipient : o.name;
    var items = o.items.map(function(i){
      var menuItem = allMenuItems.find(function(m){ return m.name === i.name; });
      return {
        id:    menuItem ? menuItem.id    : 0,
        name:  i.name,
        price: menuItem ? menuItem.price : 0,
        qty:   i.qty,
      };
    });
    var subtotal = items.reduce(function(s,i){ return s + i.price * i.qty; }, 0);
    return { name: personName, isSelf: isSelf, items: items, subtotal: subtotal };
  });

  // persons æ¸…ç©ºï¼ˆç­‰é¡§å®¢é€ä¸€ä¿®æ”¹å®Œæ‰åŠ å…¥ï¼‰
  persons = [];
  currentCart = {};
  updateCartUI();

  // é¡¯ç¤ºã€Œä¿®æ”¹è¨‚å–®ã€é¸å–®ï¼Œè®“é¡§å®¢é¸è¦æ”¹èª°
  renderEditOrdersPage();
}

function renderEditOrdersPage(){
  document.getElementById('lookupResults').innerHTML =
    '<div style="font-weight:700;font-size:14px;margin-bottom:12px;color:var(--text);">é¸æ“‡è¦ä¿®æ”¹çš„äººï¼š</div>' +
    editingOrders.map(function(p, idx){
      var label = p.isSelf ? 'ğŸ™‹ è‡ªå·±' : 'ğŸ‘« ä»£è¨‚';
      var alreadyEdited = persons.some(function(pp){ return pp.name === p.name; });
      var actionBtn = alreadyEdited
        ? '<span style="font-size:11px;color:var(--green);font-weight:700;">âœ… å·²ä¿®æ”¹</span>'
        : '<button onclick="editOnePerson(' + idx + ')" style="background:var(--blue);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;">âœï¸ ä¿®æ”¹</button>';
      return '<div class="lookup-result" style="margin-bottom:10px;">' +
        '<div class="lookup-result-header" style="display:flex;justify-content:space-between;align-items:center;">' +
          '<span class="lookup-result-id">' + label + 'ã€€' + p.name + '</span>' +
          '<div style="display:flex;gap:6px;align-items:center;">' +
            actionBtn +
            '<button onclick="removeEditingPerson(' + idx + ')" style="background:#fff;color:var(--sub);border:1px solid #ddd;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;">ç§»é™¤æ­¤äºº</button>' +
          '</div>' +
        '</div>' +
        '<div class="lookup-result-body">' +
          p.items.map(function(i){ return '<div class="lookup-result-row"><span>' + i.name + ' Ã— ' + i.qty + '</span><span style="color:var(--sub);font-size:12px;">NT$ ' + (i.price*i.qty) + '</span></div>'; }).join('') +
          '<div style="text-align:right;border-top:1px dashed #eee;margin-top:6px;padding-top:6px;font-weight:700;color:var(--red);">NT$ ' + p.subtotal + '</div>' +
        '</div>' +
      '</div>';
    }).join('') +
    (editingOrders.length > 0
      ? '<button onclick="finishEditAndSubmit()" style="width:100%;background:var(--green);color:#fff;border:none;border-radius:10px;padding:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:4px;">âœ… å®Œæˆä¿®æ”¹ï¼Œé€å‡ºè¨‚å–®</button>'
      : '<div style="text-align:center;padding:20px 0;color:var(--sub);font-size:13px;">å·²ç§»é™¤æ‰€æœ‰äººï¼Œç„¡éœ€é€å‡ºè¨‚å–®</div>');
}

function removeEditingPerson(idx){
  customConfirm('ç§»é™¤æ­¤äºº', 'ç¢ºå®šè¦ç§»é™¤ã€Œ' + editingOrders[idx].name + 'ã€çš„è¨‚å–®å—ï¼Ÿ', function(){
    // åŒæ­¥ç§»é™¤ persons è£¡å·²ä¿®æ”¹çš„ç‰ˆæœ¬
    var name = editingOrders[idx].name;
    persons = persons.filter(function(p){ return p.name !== name; });
    editingOrders.splice(idx, 1);
    if(editingOrders.length === 0){
      // å…¨éƒ¨ç§»é™¤å®Œç•¢ï¼Œä»£è¡¨æ­¤ç­†è¨‚å–®è¦æ•´å¼µåˆªé™¤
      showNotif('å·²ç§»é™¤æ‰€æœ‰äººçš„è¨‚å–®');
      renderEditOrdersPage();
    } else {
      showNotif('å·²ç§»é™¤ã€Œ' + name + 'ã€');
      renderEditOrdersPage();
    }
  });
}

function editOnePerson(idx){
  var p = editingOrders[idx];
  // æŠŠæ­¤äººæ”¾å› currentCartï¼Œè·³åˆ°é»é¤é 
  currentCart = {};
  p.items.forEach(function(i){
    if(i.id) currentCart[i.id] = { id: i.id, name: i.name, price: i.price, qty: i.qty };
  });
  document.getElementById('currentPersonName').value = p.name;
  setPersonType(p.isSelf ? 'self' : 'other');
  updateCartUI();
  renderMenu();

  // ä¿®æ”¹å®ŒæŒ‰ã€Œä¸‹ä¸€ä½ã€å¾Œè¦æŠŠæ­¤äººæ›´æ–°å› editingOrders
  // ç”¨ editingPersonIdx è¨˜ä½æ˜¯èª°
  window._editingPersonIdx = idx;
  window._isEditingExisting = true;

  hide('lookupView');
  show('menuView');
  showNotif('ä¿®æ”¹ã€Œ' + p.name + 'ã€çš„é¤é»ï¼Œå®Œæˆå¾ŒæŒ‰ã€Œï¼‹ ä¸‹ä¸€ä½ã€');
}

function finishEditAndSubmit(){
  // æŠŠé‚„æ²’ä¿®æ”¹çš„äººç›´æ¥åŠ å…¥ persons
  editingOrders.forEach(function(p){
    var alreadyIn = persons.some(function(pp){ return pp.name === p.name; });
    if(!alreadyIn) persons.push(p);
  });
  if(persons.length === 0){ showNotif('æ²’æœ‰ä»»ä½•è¨‚å–®ï¼'); return; }
  editingOrders = [];
  // é‡ç½®é€å‡ºæŒ‰éˆ•ï¼ˆç¢ºä¿ä¸æ®˜ç•™ disabled ç‹€æ…‹ï¼‰
  var btn = document.getElementById('submitBtn');
  if(btn){ btn.disabled = false; btn.textContent = 'âœ… ç¢ºèªé€å‡ºå…¨éƒ¨è¨‚å–®'; }
  // è·³åˆ°è³¼ç‰©è»Šé€å‡º
  hide('lookupView'); hide('menuView'); hide('doneView'); hide('adminView');
  show('cartView');
  renderCartView();
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function show(id){ document.getElementById(id).classList.remove('hidden'); }
function hide(id){ document.getElementById(id).classList.add('hidden'); }
function customConfirm(title, msg, onOk){
  const dlg      = document.getElementById('confirmDialog');
  const titleEl  = document.getElementById('confirmTitle');
  const msgEl    = document.getElementById('confirmMsg');
  const okBtn    = document.getElementById('confirmOkBtn');
  const cancelBtn= document.getElementById('confirmCancelBtn');
  titleEl.textContent = title;
  msgEl.textContent   = msg;
  dlg.style.display   = 'flex';

  function closeDialog(e){
    if(e){ e.stopPropagation(); e.preventDefault(); }
    dlg.style.display = 'none';
    okBtn.onclick     = null;
    cancelBtn.onclick = null;
  }
  okBtn.onclick = function(e){
    closeDialog(e);
    onOk();
  };
  cancelBtn.onclick = closeDialog;
}

function showNotif(msg){
  const n=document.getElementById('notif'); n.textContent=msg; n.classList.add('show');
  setTimeout(()=>n.classList.remove('show'),2500);
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
applySettings(SETTINGS, true);
applyShopStatus();
renderTabs(); renderMenu();
updateCartUI();
loadMenuFromSheets();
</script>
</body>
</html>
